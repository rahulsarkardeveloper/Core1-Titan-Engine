#include <iostream>
#include <fstream>
#include <vector>
#include <string>
#include <cuda_runtime.h>
#include <fcntl.h>
#include <unistd.h>
#include "../include/core1.h"

// --- Titan Data Streamer: Ultra Power Version ---
class TitanDataLoader {
private:
    float* d_pinned_buffer; // GPU ‡¶Æ‡ßá‡¶Æ‡¶∞‡¶ø‡¶§‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶∏‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶¨‡¶æ‡¶´‡¶æ‡¶∞
    size_t current_buffer_size;

public:
    TitanDataLoader(size_t size) : current_buffer_size(size) {
        // ‡ßß. Pinned Memory Allocation: ‡¶è‡¶ü‡¶ø CPU ‡¶è‡¶¨‡¶Ç GPU ‡¶è‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßç‡¶∞‡ßá‡¶∏ ‡¶∞‡ßã‡¶° ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá
        cudaError_t err = cudaMallocHost((void**)&d_pinned_buffer, size * sizeof(float));
        if (err != cudaSuccess) {
            std::cerr << "‚ùå Memory Pinning Failed: " << cudaGetErrorString(err) << std::endl;
        }
        std::cout << "üíæ Pinned Memory allocated for Ultra-Fast Streaming." << std::endl;
    }

    // ‡ß®. Zero-Latency Data Streaming Logic
    void stream_to_vram(const std::string& dataset_path, float* d_gpu_target) {
        int fd = open(dataset_path.c_str(), O_RDONLY | O_DIRECT); // Direct I/O ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
        if (fd == -1) {
            // ‡¶Ø‡¶¶‡¶ø O_DIRECT ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá, ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶≠‡¶æ‡¶¨‡ßá ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶¨‡ßá
            fd = open(dataset_path.c_str(), O_RDONLY);
        }

        if (fd != -1) {
            // ‡ß©. ‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø Pinned Memory-‡¶§‡ßá ‡¶∞‡¶ø‡¶° ‡¶ï‡¶∞‡¶æ
            ssize_t bytesRead = read(fd, d_pinned_buffer, current_buffer_size * sizeof(float));
            
            if (bytesRead > 0) {
                // ‡ß™. Asynchronous Transfer: ‡¶°‡ßá‡¶ü‡¶æ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶π‡¶¨‡ßá ‡¶Ø‡¶ñ‡¶® GPU ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡¶¨‡ßá
                cudaMemcpyAsync(d_gpu_target, d_pinned_buffer, bytesRead, cudaMemcpyHostToDevice);
                std::cout << "üöÄ Streamed " << bytesRead / (1024 * 1024) << " MB directly to A100." << std::endl;
            }
            close(fd);
        } else {
            std::cerr << "‚ùå Failed to access dataset at: " << dataset_path << std::endl;
        }
    }

    ~TitanDataLoader() {
        cudaFreeHost(d_pinned_buffer); // ‡¶Æ‡ßá‡¶Æ‡¶∞‡¶ø ‡¶Ü‡¶®-‡¶™‡¶ø‡¶® ‡¶ï‡¶∞‡¶æ
        std::cout << "üßπ Loader buffer cleared." << std::endl;
    }
};

// --- C++ Interface for Main Controller ---
extern "C" void start_titan_data_stream(const char* file_path, float* d_gpu_ptr, size_t size) {
    TitanDataLoader loader(size);
    loader.stream_to_vram(file_path, d_gpu_ptr);
}