#!/bin/bash

# --- Core 1: Titan Engine Distribution Script ---
# ‡¶è‡¶á ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü‡¶ü‡¶ø ‡ßÆ‡¶ü‡¶ø A100 GPU-‡¶∞ ‡¶∂‡¶ï‡ßç‡¶§‡¶ø‡¶ï‡ßá ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï‡ßç‡¶∞‡ßã‡¶®‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡ßá ‡¶ü‡ßç‡¶∞‡ßá‡¶®‡¶ø‡¶Ç ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶¨‡ßá‡•§

# ‡ßß. ‡¶™‡¶æ‡¶• ‡¶è‡¶¨‡¶Ç ‡¶°‡¶ø‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶∞‡¶ø ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
PROJ_ROOT=$(pwd)
BIN_NAME="core1_titan_engine"
LOG_DIR="$PROJ_ROOT/logs"
mkdir -p $LOG_DIR

# ‡ß®. NVIDIA NCCL & CUDA ‡¶è‡¶®‡¶≠‡¶æ‡¶Ø‡¶º‡¶∞‡¶®‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ö‡¶™‡ßç‡¶ü‡¶ø‡¶Æ‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶®
# A100 ‡¶è‡¶∞ ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶á ‡¶´‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ó‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ö‡¶§‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø
export NCCL_DEBUG=WARN                     # ‡¶Ö‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßÄ‡ßü ‡¶≤‡¶ó ‡¶è‡ßú‡¶ø‡ßü‡ßá ‡¶ö‡¶≤‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
export NCCL_P2P_ENABLE=1                   # NVLink Direct Access ‡¶Ö‡¶® ‡¶ï‡¶∞‡¶æ
export NCCL_IB_DISABLE=0                   # InfiniBand ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü (‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡ßá)
export CUDA_DEVICE_MAX_CONNECTIONS=1       # ‡¶ï‡¶æ‡¶∞‡ßç‡¶®‡ßá‡¶≤ ‡¶è‡¶ï‡ßç‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
export OMP_NUM_THREADS=16                  # CPU ‡¶™‡ßç‡¶∞‡¶ø-‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç ‡¶•‡ßç‡¶∞‡ßá‡¶° ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ

# ‡ß©. ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶Ö‡¶ü‡ßã-‡¶¨‡¶ø‡¶≤‡ßç‡¶° (‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶á‡¶≤ ‡¶π‡¶≤‡ßá ‡¶¨‡¶æ‡¶∞‡¶¨‡¶æ‡¶∞ ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá ‡¶®‡¶æ)
echo "üõ†Ô∏è Verifying Build Status..."
if [ ! -f "$BIN_NAME" ]; then
    echo "‚ö†Ô∏è Binary not found. Running Make..."
    make all
fi

# ‡ß™. ‡¶°‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶¨‡¶ø‡¶â‡¶ü‡ßá‡¶° ‡¶ü‡ßç‡¶∞‡ßá‡¶®‡¶ø‡¶Ç ‡¶™‡ßç‡¶Ø‡¶æ‡¶∞‡¶æ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞
NUM_GPUS=$(nvidia-smi -L | wc -l)
BATCH_SIZE_PER_GPU=64
TOTAL_BATCH_SIZE=$((NUM_GPUS * BATCH_SIZE_PER_GPU))
DATASET_PATH="$PROJ_ROOT/data/frontier_v1.bin"

echo "------------------------------------------------"
echo "üöÄ Launching Core 1 Training Cluster"
echo "üî• Target Hardware: $NUM_GPUS x NVIDIA A100"
echo "üì¶ Global Batch Size: $TOTAL_BATCH_SIZE"
echo "------------------------------------------------"

# ‡ß´. ‡¶ü‡ßç‡¶∞‡ßá‡¶®‡¶ø‡¶Ç ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ
# ‡¶Ü‡¶Æ‡¶∞‡¶æ 'stdbuf' ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶õ‡¶ø ‡¶Ø‡¶æ‡¶§‡ßá ‡¶∞‡¶ø‡ßü‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶≤‡¶ó ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡ßü
stdbuf -oL ./$BIN_NAME \
    --dataset $DATASET_PATH \
    --batch $BATCH_SIZE_PER_GPU \
    --gpus $NUM_GPUS \
    --mode "ultra_power" \
    2>&1 | tee $LOG_DIR/training_$(date +%Y%m%d_%H%M%S).log

# ‡ß¨. ‡¶ü‡ßç‡¶∞‡ßá‡¶®‡¶ø‡¶Ç ‡¶∂‡ßá‡¶∑‡ßá ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶ö‡ßá‡¶ï
if [ $? -eq 0 ]; then
    echo "‚úÖ Core 1 training cycle completed successfully."
else
    echo "‚ùå Training crashed! Check logs in $LOG_DIR for details."
fi