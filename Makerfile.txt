# --- Core 1 Titan Engine Build System ---

# ‡ßß. ‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶á‡¶≤‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶ü‡ßÅ‡¶≤‡¶∏ ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
CXX      = g++
NVCC     = nvcc
RUST     = cargo
RM       = rm -rf

# ‡ß®. ‡¶™‡¶æ‡¶• ‡¶è‡¶¨‡¶Ç ‡¶°‡¶ø‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶∞‡¶ø
SRC_DIR  = src
INC_DIR  = include
RUST_DIR = src/rust_tokenizer
OBJ_DIR  = obj
BIN      = core1_titan_engine

# ‡ß©. ‡¶´‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ó‡¶∏ (A100 ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø SM_80 ‡¶Ü‡¶∞‡ßç‡¶ï‡¶ø‡¶ü‡ßá‡¶ï‡¶ö‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶∏‡ßç‡¶ü)
CXXFLAGS = -O3 -std=c++20 -I$(INC_DIR) -fopenmp
NVFLAGS  = -O3 -arch=sm_80 -Xcompiler -fPIC -I$(INC_DIR)
RUSTFLAGS = --release

# ‡ß™. ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï‡¶ø‡¶Ç (CUDA, NCCL ‡¶è‡¶¨‡¶Ç Rust ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶ø‡¶ï ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø)
LIBS = -L$(RUST_DIR)/target/release -lcore1_tokenizer -lcudart -lnccl -lrt -ldl -lpthread

# ‡ß´. ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶´‡¶æ‡¶á‡¶≤ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü
OBJS = $(OBJ_DIR)/main.o $(OBJ_DIR)/engine.o $(OBJ_DIR)/loader.o

# --- ‡¶¨‡¶ø‡¶≤‡ßç‡¶° ‡¶∞‡ßÅ‡¶≤‡¶∏ ---

all: setup build_rust $(BIN)

# ‡¶°‡¶ø‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶∞‡¶ø ‡¶§‡ßà‡¶∞‡¶ø
setup:
	@mkdir -p $(OBJ_DIR)

# ‡¶∞‡¶æ‡¶∏‡ßç‡¶ü ‡¶ü‡ßã‡¶ï‡ßá‡¶®‡¶æ‡¶á‡¶ú‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶≤‡ßç‡¶° (Static Library .a ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶¨‡ßá)
build_rust:
	@echo "ü¶Ä Building Rust Tokenizer..."
	@cd $(RUST_DIR) && $(RUST) build $(RUSTFLAGS)

# ‡¶∏‡¶ø++ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶á‡¶≤
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cpp
	@echo "üíª Compiling C++: $<"
	@$(CXX) $(CXXFLAGS) -c $< -o $@

# ‡¶ï‡ßÅ‡¶°‡¶æ (CUDA) ‡¶´‡¶æ‡¶á‡¶≤ ‡¶ï‡¶Æ‡ßç‡¶™‡¶æ‡¶á‡¶≤
$(OBJ_DIR)/engine.o: $(SRC_DIR)/engine.cu
	@echo "üî• Compiling CUDA Kernels for A100: $<"
	@$(NVCC) $(NVFLAGS) -c $< -o $@

# ‡¶´‡¶æ‡¶á‡¶®‡¶æ‡¶≤ ‡¶¨‡¶æ‡¶á‡¶®‡¶æ‡¶∞‡¶ø ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï‡¶ø‡¶Ç
$(BIN): $(OBJS)
	@echo "üîó Linking everything into Core 1 Engine..."
	@$(CXX) $(CXXFLAGS) $(OBJS) -o $(BIN) $(LIBS)
	@echo "‚úÖ Build Complete: ./$(BIN)"

# ‡¶ï‡ßç‡¶≤‡¶ø‡¶®‡¶ø‡¶Ç
clean:
	@echo "üßπ Cleaning up..."
	@$(RM) $(OBJ_DIR) $(BIN)
	@cd $(RUST_DIR) && $(RUST) clean

.PHONY: all setup build_rust clean